!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("Clappr")):"function"==typeof define&&define.amd?define(["Clappr"],e):"object"==typeof exports?exports.ClapprStats=e(require("Clappr")):t.ClapprStats=e(t.Clappr)}(this,function(t){return function(t){function e(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var n={};return e.m=t,e.c=n,e.i=function(t){return t},e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=3)}([function(t,e,n){"use strict";(function(e){function n(t,e){return null==t?void 0:t[e]}function r(t){var e=!1;if(null!=t&&"function"!=typeof t.toString)try{e=!!(t+"")}catch(t){}return e}function i(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function o(){this.__data__=vt?vt(null):{}}function s(t){return this.has(t)&&delete this.__data__[t]}function a(t){var e=this.__data__;if(vt){var n=e[t];return n===Y?void 0:n}return lt.call(e,t)?e[t]:void 0}function u(t){var e=this.__data__;return vt?void 0!==e[t]:lt.call(e,t)}function c(t,e){return this.__data__[t]=vt&&void 0===e?Y:e,this}function h(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function l(){this.__data__=[]}function f(t){var e=this.__data__,n=g(e,t);return!(n<0)&&(n==e.length-1?e.pop():dt.call(e,n,1),!0)}function p(t){var e=this.__data__,n=g(e,t);return n<0?void 0:e[n][1]}function _(t){return g(this.__data__,t)>-1}function d(t,e){var n=this.__data__,r=g(n,t);return r<0?n.push([t,e]):n[r][1]=e,this}function y(t){var e=-1,n=t?t.length:0;for(this.clear();++e<n;){var r=t[e];this.set(r[0],r[1])}}function v(){this.__data__={hash:new i,map:new(yt||h),string:new i}}function m(t){return N(this,t).delete(t)}function b(t){return N(this,t).get(t)}function T(t){return N(this,t).has(t)}function E(t,e){return N(this,t).set(t,e),this}function g(t,e){for(var n=t.length;n--;)if(F(t[n][0],e))return n;return-1}function w(t,e){e=x(e,t)?[e]:k(e);for(var n=0,r=e.length;null!=t&&n<r;)t=t[S(e[n++])];return n&&n==r?t:void 0}function P(t){return!(!I(t)||A(t))&&(j(t)||r(t)?pt:et).test(M(t))}function O(t){if("string"==typeof t)return t;if(H(t))return bt?bt.call(t):"";var e=t+"";return"0"==e&&1/t==-V?"-0":e}function k(t){return Et(t)?t:Tt(t)}function N(t,e){var n=t.__data__;return C(e)?n["string"==typeof e?"string":"hash"]:n.map}function R(t,e){var r=n(t,e);return P(r)?r:void 0}function x(t,e){if(Et(t))return!1;var n=void 0===t?"undefined":G(t);return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=t&&!H(t))||(J.test(t)||!q.test(t)||null!=e&&t in Object(e))}function C(t){var e=void 0===t?"undefined":G(t);return"string"==e||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==t:null===t}function A(t){return!!ct&&ct in t}function S(t){if("string"==typeof t||H(t))return t;var e=t+"";return"0"==e&&1/t==-V?"-0":e}function M(t){if(null!=t){try{return ht.call(t)}catch(t){}try{return t+""}catch(t){}}return""}function B(t,e){if("function"!=typeof t||e&&"function"!=typeof e)throw new TypeError($);var n=function n(){var r=arguments,i=e?e.apply(this,r):r[0],o=n.cache;if(o.has(i))return o.get(i);var s=t.apply(this,r);return n.cache=o.set(i,s),s};return n.cache=new(B.Cache||y),n}function F(t,e){return t===e||t!==t&&e!==e}function j(t){var e=I(t)?ft.call(t):"";return e==W||e==z}function I(t){var e=void 0===t?"undefined":G(t);return!!t&&("object"==e||"function"==e)}function L(t){return!!t&&"object"==(void 0===t?"undefined":G(t))}function H(t){return"symbol"==(void 0===t?"undefined":G(t))||L(t)&&ft.call(t)==K}function U(t){return null==t?"":O(t)}function D(t,e,n){var r=null==t?void 0:w(t,e);return void 0===r?n:r}var G="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},$="Expected a function",Y="__lodash_hash_undefined__",V=1/0,W="[object Function]",z="[object GeneratorFunction]",K="[object Symbol]",q=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,J=/^\w*$/,X=/^\./,Q=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Z=/[\\^$.*+?()[\]{}|]/g,tt=/\\(\\)?/g,et=/^\[object .+?Constructor\]$/,nt="object"==(void 0===e?"undefined":G(e))&&e&&e.Object===Object&&e,rt="object"==("undefined"==typeof self?"undefined":G(self))&&self&&self.Object===Object&&self,it=nt||rt||Function("return this")(),ot=Array.prototype,st=Function.prototype,at=Object.prototype,ut=it["__core-js_shared__"],ct=function(){var t=/[^.]+$/.exec(ut&&ut.keys&&ut.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""}(),ht=st.toString,lt=at.hasOwnProperty,ft=at.toString,pt=RegExp("^"+ht.call(lt).replace(Z,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),_t=it.Symbol,dt=ot.splice,yt=R(it,"Map"),vt=R(Object,"create"),mt=_t?_t.prototype:void 0,bt=mt?mt.toString:void 0;i.prototype.clear=o,i.prototype.delete=s,i.prototype.get=a,i.prototype.has=u,i.prototype.set=c,h.prototype.clear=l,h.prototype.delete=f,h.prototype.get=p,h.prototype.has=_,h.prototype.set=d,y.prototype.clear=v,y.prototype.delete=m,y.prototype.get=b,y.prototype.has=T,y.prototype.set=E;var Tt=B(function(t){t=U(t);var e=[];return X.test(t)&&e.push(""),t.replace(Q,function(t,n,r,i){e.push(r?i.replace(tt,"$1"):n||t)}),e});B.Cache=y;var Et=Array.isArray;t.exports=D}).call(e,n(2))},function(e,n){e.exports=t},function(t,e,n){"use strict";var r,i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};r=function(){return this}();try{r=r||Function("return this")()||(0,eval)("this")}catch(t){"object"===("undefined"==typeof window?"undefined":i(window))&&(r=window)}t.exports=r},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Object.defineProperty(e,"__esModule",{value:!0});var s=function t(e,n,r){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,n);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,r)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(r)},a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),u=n(1),c=n(0),h=function(t){return t&&t.__esModule?t:{default:t}}(c),l=function(t){function e(t){r(this,e);var n=i(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n._runEach=(0,h.default)(t,"options.clapprStats.runEach",5e3),n._onReport=(0,h.default)(t,"options.clapprStats.onReport",n._defaultReport),n._uriToMeasureLatency=(0,h.default)(t,"options.clapprStats.uriToMeasureLatency"),n._urisToMeasureBandwidth=(0,h.default)(t,"options.clapprStats.urisToMeasureBandwidth"),n._runBandwidthTestEvery=(0,h.default)(t,"options.clapprStats.runBandwidthTestEvery",10),n._bwMeasureCount=0,n._completion={watch:(0,h.default)(t,"options.clapprStats.onCompletion",[]),calls:[]},n._newMetrics(),n.on(e.REPORT_EVENT,n._onReport),n}return o(e,t),a(e,[{key:"_now",value:function(){return window.performance&&"function"==typeof window.performance.now?window.performance.now():new Date}},{key:"_inc",value:function(t){this._metrics.counters[t]+=1}},{key:"_timerHasStarted",value:function(t){return void 0!==this["_start"+t]}},{key:"_start",value:function(t){this["_start"+t]=this._now()}},{key:"_stop",value:function(t){this._metrics.timers[t]+=this._now()-this["_start"+t]}},{key:"_defaultReport",value:function(t){console.log(t)}},{key:"name",get:function(){return"clappr_stats"}},{key:"_playbackName",get:function(){return this.container.playback.name}},{key:"_playbackType",get:function(){return this.container.getPlaybackType()}}]),a(e,[{key:"bindEvents",value:function(){var t=this;this.listenTo(this.container,u.Events.CONTAINER_BITRATE,this.onBitrate),this.listenTo(this.container,u.Events.CONTAINER_STOP,this.stopReporting),this.listenTo(this.container,u.Events.CONTAINER_ENDED,this.stopReporting),this.listenToOnce(this.container.playback,u.Events.PLAYBACK_PLAY_INTENT,this.startTimers),this.listenToOnce(this.container,u.Events.CONTAINER_PLAY,this.onFirstPlaying),this.listenTo(this.container,u.Events.CONTAINER_PLAY,this.onPlay),this.listenTo(this.container,u.Events.CONTAINER_PAUSE,this.onPause),this.listenToOnce(this.container,u.Events.CONTAINER_STATE_BUFFERING,this.onBuffering),this.listenTo(this.container,u.Events.CONTAINER_SEEK,this.onSeek),this.listenTo(this.container,u.Events.CONTAINER_ERROR,function(){return t._inc("error")}),this.listenTo(this.container,u.Events.CONTAINER_FULLSCREEN,function(){return t._inc("fullscreen")}),this.listenTo(this.container,u.Events.CONTAINER_PLAYBACKDVRSTATECHANGED,function(e){e&&t._inc("dvrUsage")}),this.listenTo(this.container.playback,u.Events.PLAYBACK_PROGRESS,this.onProgress),this.listenTo(this.container.playback,u.Events.PLAYBACK_TIMEUPDATE,this.onTimeUpdate)}},{key:"destroy",value:function(){this.stopReporting(),s(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"destroy",this).call(this)}},{key:"onBitrate",value:function(t){var e=parseInt((0,h.default)(t,"bitrate",0),10),n=this._now();if(this._metrics.extra.bitratesHistory.length>0){var r=this._metrics.extra.bitratesHistory[this._metrics.extra.bitratesHistory.length-1];r.end=n,r.time=n-r.start}this._metrics.extra.bitratesHistory.push({start:this._now(),bitrate:e}),this._inc("changeLevel")}},{key:"stopReporting",value:function(){this._buildReport(),clearInterval(this._intervalId),this._newMetrics(),this.stopListening(),this.bindEvents()}},{key:"startTimers",value:function(){this._intervalId=setInterval(this._buildReport.bind(this),this._runEach),this._start("session"),this._start("startup")}},{key:"onFirstPlaying",value:function(){this.listenTo(this.container,u.Events.CONTAINER_TIMEUPDATE,this.onContainerUpdateWhilePlaying),this._start("watch"),this._stop("startup")}},{key:"playAfterPause",value:function(){this.listenTo(this.container,u.Events.CONTAINER_TIMEUPDATE,this.onContainerUpdateWhilePlaying),this._stop("pause"),this._start("watch")}},{key:"onPlay",value:function(){this._inc("play")}},{key:"onPause",value:function(){this._stop("watch"),this._start("pause"),this._inc("pause"),this.listenToOnce(this.container,u.Events.CONTAINER_PLAY,this.playAfterPause),this.stopListening(this.container,u.Events.CONTAINER_TIMEUPDATE,this.onContainerUpdateWhilePlaying)}},{key:"onSeek",value:function(t){this._inc("seek"),this._metrics.extra.watchHistory.push([1e3*t,1e3*t])}},{key:"onTimeUpdate",value:function(t){var e=1e3*t.current,n=1e3*t.total,r=this._metrics.extra.watchHistory.length;if(this._metrics.extra.duration=n,this._metrics.extra.currentTime=e,this._metrics.extra.watchedPercentage=e/n*100,0===r?this._metrics.extra.watchHistory.push([e,e]):this._metrics.extra.watchHistory[r-1][1]=e,this._metrics.extra.bitratesHistory.length>0){var i=this._metrics.extra.bitratesHistory[this._metrics.extra.bitratesHistory.length-1];i.end||(i.time=this._now()-i.start)}this._onCompletion()}},{key:"onContainerUpdateWhilePlaying",value:function(){this.container.playback.isPlaying()&&(this._stop("watch"),this._start("watch"))}},{key:"onBuffering",value:function(){this._inc("buffering"),this._start("buffering"),this.listenToOnce(this.container,u.Events.CONTAINER_STATE_BUFFERFULL,this.onBufferfull)}},{key:"onBufferfull",value:function(){this._stop("buffering"),this.listenToOnce(this.container,u.Events.CONTAINER_STATE_BUFFERING,this.onBuffering)}},{key:"onProgress",value:function(t){this._metrics.extra.buffersize=1e3*t.current}},{key:"_newMetrics",value:function(){this._metrics={counters:{play:0,pause:0,error:0,buffering:0,decodedFrames:0,droppedFrames:0,fps:0,changeLevel:0,seek:0,fullscreen:0,dvrUsage:0},timers:{startup:0,watch:0,pause:0,buffering:0,session:0,latency:0},extra:{playbackName:"",playbackType:"",bitratesHistory:[],bitrateWeightedMean:0,bitrateMostUsed:0,buffersize:0,watchHistory:[],watchedPercentage:0,bufferingPercentage:0,bandwidth:0,duration:0,currentTime:0}}}},{key:"_onCompletion",value:function(){var t=this._metrics.extra.watchedPercentage,n=this._completion.watch,r=-1!=this._completion.calls.indexOf(t);-1==n.indexOf(t)||r||(u.Log.info(this.name+" PERCENTAGE_EVENT: "+t),this._completion.calls.push(t),this.trigger(e.PERCENTAGE_EVENT,t))}},{key:"_buildReport",value:function(){this._stop("session"),this._start("session"),this._metrics.extra.playbackName=this._playbackName,this._metrics.extra.playbackType=this._playbackType,this._calculateBitrates(),this._calculatePercentages(),this._fetchFPS(),this._measureLatency(),this._measureBandwidth(),this.trigger(e.REPORT_EVENT,JSON.parse(JSON.stringify(this._metrics)))}},{key:"_fetchFPS",value:function(){var t={html5_video:this._html5FetchFPS,hls:this._html5FetchFPS,dash_shaka_playback:this._html5FetchFPS};t[this._playbackName]&&t[this._playbackName].call(this)}},{key:"_calculateBitrates",value:function(){var t=this._metrics.extra.bitratesHistory.map(function(t){return t.time}).reduce(function(t,e){return t+e},0);this._metrics.extra.bitrateWeightedMean=this._metrics.extra.bitratesHistory.map(function(t){return t.bitrate*t.time}).reduce(function(t,e){return t+e},0)/t,this._metrics.extra.bitratesHistory.length>0&&(this._metrics.extra.bitrateMostUsed=this._metrics.extra.bitratesHistory.slice().sort(function(t,e){return t.time<e.time})[0].bitrate)}},{key:"_calculatePercentages",value:function(){this._metrics.extra.duration>0&&(this._metrics.extra.bufferingPercentage=this._metrics.timers.buffering/this._metrics.extra.duration*100)}},{key:"_html5FetchFPS",value:function(){var t=this.container.playback.el,e=t.webkitDecodedFrameCount||t.mozDecodedFrames||0,n=t.webkitDroppedFrameCount||t.mozParsedFrames-t.mozDecodedFrames||0,r=e-(this._lastDecodedFramesCount||0);this._metrics.counters.decodedFrames=e,this._metrics.counters.droppedFrames=n,this._metrics.counters.fps=r/(this._runEach/1e3),this._lastDecodedFramesCount=e}},{key:"_measureLatency",value:function(){var t=this;if(this._uriToMeasureLatency){var e,n=[],r=function(){e=n[2]-n[1],t._metrics.timers.latency=e};!function e(){if(n.push(t._now()),n.length>2)r();else{var i=new Image;i.onload=e,i.src=t._uriToMeasureLatency+"?"+Math.random()+"="+t._now()}}()}}},{key:"_measureBandwidth",value:function(){var t=this;if(this._urisToMeasureBandwidth&&this._bwMeasureCount%this._runBandwidthTestEvery==0){var e=0,n=function(n){var r=(t._urisToMeasureBandwidth[e-1].end-t._urisToMeasureBandwidth[e-1].start)/1e3,i=8*n.loaded/r;t._metrics.extra.bandwidth=i,t._urisToMeasureBandwidth.forEach(function(t){t.start=0,t.end=0,t.expired=!1,clearTimeout(t.timer)})};!function r(i){if(e>0&&(t._urisToMeasureBandwidth[e-1].end=t._now(),clearTimeout(t._urisToMeasureBandwidth[e-1].timer)),e>=t._urisToMeasureBandwidth.length||e>0&&t._urisToMeasureBandwidth[e-1].expired)n(i);else{var o=new XMLHttpRequest;o.open("GET",t._urisToMeasureBandwidth[e].url,!0),o.responseType="arraybuffer",o.onload=o.onabort=r,t._urisToMeasureBandwidth[e].start=t._now(),t._urisToMeasureBandwidth[e].timer=setTimeout(function(e){t._urisToMeasureBandwidth[e].expired=!0,o.abort()},t._urisToMeasureBandwidth[e].timeout,e),o.send()}e++}()}this._bwMeasureCount++}}]),e}(u.ContainerPlugin);e.default=l,l.REPORT_EVENT="clappr:stats:report",l.PERCENTAGE_EVENT="clappr:stats:percentage",t.exports=e.default}])});